name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

# Cancel in-progress runs for same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'

jobs:
  # ============================================
  # JOB 1: Lint and Type Check
  # ============================================
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'web-ui/package-lock.json'

      - name: Install Frontend Dependencies
        working-directory: ./web-ui
        run: npm ci

      - name: Run ESLint
        working-directory: ./web-ui
        run: npm run lint
        continue-on-error: false

      - name: Run TypeScript Type Check
        working-directory: ./web-ui
        run: npx tsc --noEmit
        continue-on-error: false

      - name: Check TypeScript strict mode
        working-directory: ./web-ui
        run: |
          echo "Checking for 'any' usage..."
          any_count=$(grep -r "any" --include="*.ts" --include="*.tsx" app/ components/ lib/ | wc -l || echo "0")
          echo "Found $any_count instances of 'any'"
          echo "any_count=$any_count" >> $GITHUB_OUTPUT
        id: any_check

      - name: Comment 'any' count on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const anyCount = ${{ steps.any_check.outputs.any_count }};
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `### TypeScript 'any' Usage Report\n\nFound **${anyCount}** instances of 'any' type.\n\nTarget: < 50 instances`
            });

  # ============================================
  # JOB 2: Backend Tests
  # ============================================
  test-backend:
    name: Backend Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio

      - name: Run Python Tests
        run: |
          pytest tests/ -v --cov=api --cov-report=xml --cov-report=term
        continue-on-error: false

      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          flags: backend
          name: backend-coverage

  # ============================================
  # JOB 3: Frontend Unit Tests
  # ============================================
  test-frontend-unit:
    name: Frontend Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'web-ui/package-lock.json'

      - name: Install Dependencies
        working-directory: ./web-ui
        run: npm ci

      - name: Run Unit Tests
        working-directory: ./web-ui
        run: npm run test:unit
        env:
          CI: true

      - name: Upload Coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./web-ui/coverage/coverage-final.json
          flags: frontend-unit
          name: frontend-unit-coverage

  # ============================================
  # JOB 4: Frontend Build
  # ============================================
  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    needs: [lint]
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'web-ui/package-lock.json'

      - name: Install Dependencies
        working-directory: ./web-ui
        run: npm ci

      - name: Build Next.js App
        working-directory: ./web-ui
        run: npm run build
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}

      - name: Check Build Size
        working-directory: ./web-ui
        run: |
          echo "Analyzing bundle size..."
          du -sh .next/
          echo "Checking for large chunks..."
          find .next/static/chunks -type f -size +500k -exec ls -lh {} \;

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: web-ui/.next/
          retention-days: 7

  # ============================================
  # JOB 5: Security Tests (RLS)
  # ============================================
  test-security:
    name: Security Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    timeout-minutes: 10

    services:
      postgres:
        image: supabase/postgres:15.1.0.117
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Dependencies
        run: |
          cd web-ui && npm ci
          npm install --save-dev @supabase/supabase-js vitest

      - name: Run Security Tests
        run: npm run test:security
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}

  # ============================================
  # JOB 6: E2E Tests (on main only)
  # ============================================
  test-e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    needs: [build-frontend]
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'web-ui/package-lock.json'

      - name: Install Dependencies
        working-directory: ./web-ui
        run: npm ci

      - name: Install Playwright
        working-directory: ./web-ui
        run: npx playwright install --with-deps chromium

      - name: Download Build
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: web-ui/.next/

      - name: Run E2E Tests
        working-directory: ./web-ui
        run: npm run test:e2e
        env:
          CI: true
          BASE_URL: http://localhost:3000

      - name: Upload Playwright Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: web-ui/playwright-report/
          retention-days: 30

  # ============================================
  # JOB 7: Deploy Preview (PRs)
  # ============================================
  deploy-preview:
    name: Deploy Preview
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: [lint, test-frontend-unit, build-frontend]
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Pull Vercel Environment
        working-directory: ./web-ui
        run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}

      - name: Build Project
        working-directory: ./web-ui
        run: vercel build --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy Preview
        working-directory: ./web-ui
        run: |
          vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }} > deployment-url.txt
          echo "DEPLOYMENT_URL=$(cat deployment-url.txt)" >> $GITHUB_ENV

      - name: Comment Preview URL
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## üöÄ Preview Deployment\n\n‚úÖ Deployed to: ${{ env.DEPLOYMENT_URL }}\n\nTest the changes before merging!`
            });

  # ============================================
  # JOB 8: Deploy Production (main only)
  # ============================================
  deploy-production:
    name: Deploy Production
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    needs: [lint, test-frontend-unit, test-backend, build-frontend, test-security]
    timeout-minutes: 15
    environment:
      name: production
      url: https://aiassistant.vercel.app

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Pull Vercel Environment
        working-directory: ./web-ui
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

      - name: Build Project
        working-directory: ./web-ui
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy to Production
        working-directory: ./web-ui
        run: |
          vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy Backend (Railway)
        run: |
          # Install Railway CLI
          curl -fsSL https://railway.app/install.sh | sh
          # Deploy backend
          railway up --service backend
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

  # ============================================
  # JOB 9: Notify on Failure
  # ============================================
  notify-failure:
    name: Notify Failure
    runs-on: ubuntu-latest
    if: failure()
    needs: [lint, test-frontend-unit, test-backend, build-frontend]

    steps:
      - name: Send Slack Notification
        if: env.SLACK_WEBHOOK_URL != ''
        run: |
          curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
            -H 'Content-Type: application/json' \
            -d '{
              "text": "‚ùå CI/CD Pipeline Failed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Build Failed*\n\nWorkflow: ${{ github.workflow }}\nBranch: ${{ github.ref }}\nCommit: ${{ github.sha }}\nAuthor: ${{ github.actor }}"
                  }
                }
              ]
            }'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Create GitHub Issue on Failure
        if: github.ref == 'refs/heads/main'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `CI/CD Pipeline Failed - ${context.sha.substring(0, 7)}`,
              body: `## Pipeline Failure Report\n\n**Workflow:** ${context.workflow}\n**Branch:** ${context.ref}\n**Commit:** ${context.sha}\n**Author:** ${context.actor}\n\n[View Workflow Run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`,
              labels: ['bug', 'ci-cd', 'high-priority']
            });
