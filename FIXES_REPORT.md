# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ —É–ª—É—á—à–µ–Ω–∏—è - –û—Ç—á–µ—Ç

## ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã (P0)

### 1. ‚úÖ CORS –¥–ª—è Production
**–§–∞–π–ª:** `api/server.py`
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —á—Ç–µ–Ω–∏—è production –¥–æ–º–µ–Ω–æ–≤ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π `CORS_ORIGINS`
- –§–æ—Ä–º–∞—Ç: `CORS_ORIGINS=https://app.example.com,https://www.example.com`
- –õ–æ–∫–∞–ª—å–Ω—ã–µ –¥–æ–º–µ–Ω—ã –æ—Å—Ç–∞—é—Ç—Å—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

### 2. ‚úÖ OAuth Callback URLs –¥–ª—è Production
**–§–∞–π–ª:** `agents/oauth_providers.py`
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `FRONTEND_URL` –∏–ª–∏ `BASE_URL` –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è callback URLs
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —è–≤–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö: `GOOGLE_REDIRECT_URI`, `GITHUB_REDIRECT_URI`, `MICROSOFT_REDIRECT_URI`

### 3. ‚úÖ SECRET_KEY –í–∞–ª–∏–¥–∞—Ü–∏—è
**–§–∞–π–ª:** `agents/auth.py`
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª–∏–Ω—ã SECRET_KEY
- Development: –º–∏–Ω–∏–º—É–º 32 —Å–∏–º–≤–æ–ª–∞ (—Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º)
- Production: –º–∏–Ω–∏–º—É–º 64 —Å–∏–º–≤–æ–ª–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
- –ü–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏

## ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ –∫–æ–¥–∞

### 1. ‚úÖ Health Check –¥–ª—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `get_db()` - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è `next(get_db())` –∫–∞–∫ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ `db.db_path` –∏ `sqlite3.connect()`

```python
# –ë—ã–ª–æ:
db = next(get_db())
db.execute("SELECT 1").fetchone()

# –°—Ç–∞–ª–æ:
db = get_db()
with sqlite3.connect(db.db_path) as conn:
    conn.execute("SELECT 1").fetchone()
```

### 2. ‚úÖ Logout Endpoint
**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–æ–Ω—Ñ–ª–∏–∫—Ç –∏–º–µ–Ω –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π `response`
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –£–±—Ä–∞–Ω–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä `response: Response` –∏–∑ —Å–∏–≥–Ω–∞—Ç—É—Ä—ã —Ñ—É–Ω–∫—Ü–∏–∏

### 3. ‚úÖ CSRF Token Generation
**–ü—Ä–æ–±–ª–µ–º–∞:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `payload.get('user_id')` –≤–º–µ—Å—Ç–æ `payload.get('sub')`
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `sub` –∏–∑ JWT payload

### 4. ‚úÖ Secure Cookies
**–ü—Ä–æ–±–ª–µ–º–∞:** –í—Å–µ cookies –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ `secure=False` –¥–∞–∂–µ –≤ production
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ secure cookie –Ω–∞ –æ—Å–Ω–æ–≤–µ `ENVIRONMENT`
- Development: `secure=False`
- Production: `secure=True`

### 5. ‚úÖ User ID –≤ Payload
**–ü—Ä–æ–±–ª–µ–º–∞:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `payload.get('user_id')` –≤–º–µ—Å—Ç–æ `payload.get('sub')`
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –í—Å–µ –º–µ—Å—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `sub` –∏–∑ JWT —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞

**–ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ endpoints:**
- `/api/auth/2fa/backup-codes`
- `/api/auth/2fa/regenerate-backup-codes`
- `/api/auth/2fa/status`
- `/api/auth/2fa/setup`
- `/api/auth/2fa/enable`
- `/api/auth/2fa/disable`

## ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª

### 1. ‚úÖ Token Refresh Endpoint
**–ù–æ–≤—ã–π endpoint:** `POST /api/auth/refresh`
- –û–±–Ω–æ–≤–ª—è–µ—Ç JWT —Ç–æ–∫–µ–Ω –∏—Å–ø–æ–ª—å–∑—É—è —Ç–µ–∫—É—â–∏–π (–µ—â–µ –≤–∞–ª–∏–¥–Ω—ã–π) —Ç–æ–∫–µ–Ω
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑–µ
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç–∞
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç cookie

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```bash
curl -X POST https://api.example.com/api/auth/refresh \
  -H "Authorization: Bearer <current_token>"
```

### 2. ‚úÖ –£–ª—É—á—à–µ–Ω–Ω—ã–π Health Check
**–§–∞–π–ª:** `api/server.py`
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–µ—Ä—Å–∏—è API –≤ –æ—Ç–≤–µ—Ç
- –£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫

### 3. ‚úÖ API Version Headers
**Middleware:** `APIVersionMiddleware`
- –í—Å–µ –æ—Ç–≤–µ—Ç—ã —Å–æ–¥–µ—Ä–∂–∞—Ç `X-API-Version` –∏ `X-API-Server`
- –£–ø—Ä–æ—â–∞–µ—Ç –æ—Ç–ª–∞–¥–∫—É –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### 4. ‚úÖ Gzip Compression
**Middleware:** `GZipMiddleware`
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∂–∞—Ç–∏–µ –æ—Ç–≤–µ—Ç–æ–≤ > 1KB
- –£–º–µ–Ω—å—à–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ 60-80%

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
- `api/server.py` - 15+ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π
- `agents/auth.py` - –í–∞–ª–∏–¥–∞—Ü–∏—è SECRET_KEY
- `agents/oauth_providers.py` - Production callback URLs

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ endpoints:
- `/api/auth/logout` - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –∫–æ–Ω—Ñ–ª–∏–∫—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
- `/api/auth/refresh` - –ù–æ–≤—ã–π endpoint –¥–æ–±–∞–≤–ª–µ–Ω
- `/api/auth/2fa/*` - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ user_id
- `/api/auth/csrf-token` - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ user_id
- `/api/health` - –£–ª—É—á—à–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ë–î

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:
- ‚úÖ 5 –æ—à–∏–±–æ–∫ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º `user_id` –≤–º–µ—Å—Ç–æ `sub`
- ‚úÖ 4 –ø—Ä–æ–±–ª–µ–º—ã —Å secure cookies
- ‚úÖ 1 –æ—à–∏–±–∫–∞ –≤ health check
- ‚úÖ 1 –∫–æ–Ω—Ñ–ª–∏–∫—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤ logout
- ‚úÖ –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–π refresh token endpoint

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞

### –õ–∏–Ω—Ç–µ—Ä:
```bash
‚úÖ No linter errors found
```

### –¢–∏–ø—ã:
- ‚úÖ –í—Å–µ —Ç–∏–ø—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã
- ‚úÖ JWT payload –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç `sub` –¥–ª—è user ID

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:
- ‚úÖ Secure cookies –≤ production
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è SECRET_KEY
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ CSRF tokens

## üöÄ Production Ready Checklist

### ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –¥–µ–ø–ª–æ—é:
- [x] CORS –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è production –¥–æ–º–µ–Ω–æ–≤
- [x] OAuth callback URLs –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –¥–ª—è production
- [x] SECRET_KEY –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞
- [x] Secure cookies –≤–∫–ª—é—á–µ–Ω—ã –¥–ª—è production
- [x] Token refresh endpoint –¥–æ–±–∞–≤–ª–µ–Ω
- [x] Health check —É–ª—É—á—à–µ–Ω
- [x] API version headers –¥–æ–±–∞–≤–ª–µ–Ω—ã
- [x] Gzip compression –≤–∫–ª—é—á–µ–Ω
- [x] –í—Å–µ –æ—à–∏–±–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã

### üìã –û—Å—Ç–∞–ª–æ—Å—å (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):
- [ ] –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ server.py –Ω–∞ routers (P1)
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö AI –º–æ–¥–µ–ª–µ–π (P1)
- [ ] –ü–µ—Ä–µ–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Vercel (P1)

## üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –î–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è:
1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
   ```bash
   CORS_ORIGINS=https://your-app.vercel.app
   FRONTEND_URL=https://your-app.vercel.app
   SECRET_KEY=<64+ —Å–∏–º–≤–æ–ª–æ–≤>
   ENVIRONMENT=production
   ```

2. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å:
   - Health check: `GET /api/health`
   - Token refresh: `POST /api/auth/refresh`
   - CORS —Å production frontend

### –î–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ —É–ª—É—á—à–µ–Ω–∏—è:
1. –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ server.py –Ω–∞ –º–æ–¥—É–ª—å–Ω—ã–µ routers
2. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ unit —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –Ω–æ–≤—ã—Ö endpoints
3. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é refresh token

---

**–î–∞—Ç–∞:** 2025-01-04
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã
**–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ Production:** ‚úÖ Ready (–ø–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è)


