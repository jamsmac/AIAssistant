# üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Stripe Integration

## Stripe CLI —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω ‚úÖ

–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å webhook –ª–æ–∫–∞–ª—å–Ω–æ –∏ —É–¥–∞–ª–µ–Ω–Ω–æ.

## –í–∞—Ä–∏–∞–Ω—Ç 1: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ Stripe Dashboard (–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

### –®–∞–≥ 1: –û–±–Ω–æ–≤–∏—Ç–µ URL webhook

1. –û—Ç–∫—Ä–æ–π—Ç–µ: https://dashboard.stripe.com/test/webhooks
2. –ù–∞–π–¥–∏—Ç–µ webhook: `we_1SR4zwBk4MbPWMlrQLAtGDgw`
3. –ù–∞–∂–º–∏—Ç–µ "Update details"
4. –í–≤–µ–¥–∏—Ç–µ URL:
   ```
   https://aiassistant-production-7a4d.up.railway.app/api/credits/webhook
   ```
5. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –≤—ã–±—Ä–∞–Ω event: `checkout.session.completed`
6. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ

### –®–∞–≥ 2: –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ webhook –≤ Dashboard

1. –í Stripe Dashboard –æ—Ç–∫—Ä–æ–π—Ç–µ –≤–∞—à webhook
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É **"Testing"**
3. –í—ã–±–µ—Ä–∏—Ç–µ event: `checkout.session.completed`
4. –ù–∞–∂–º–∏—Ç–µ **"Send test webhook"**
5. –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç–≤–µ—Ç: `‚úÖ 200 OK`

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Railway

```bash
railway logs --service a356894b-78b6-4746-8cf4-69103f40b474 | grep webhook
```

–î–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:
```
Webhook received for checkout session...
Successfully added X credits to user Y...
```

## –í–∞—Ä–∏–∞–Ω—Ç 2: –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å Stripe CLI

### –®–∞–≥ 1: –ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å –≤ Stripe CLI

```bash
stripe login
```

–≠—Ç–æ –æ—Ç–∫—Ä–æ–µ—Ç –±—Ä–∞—É–∑–µ—Ä –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –°–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º.

### –®–∞–≥ 2: –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤—å—Ç–µ webhooks –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä

–ï—Å–ª–∏ –≤–∞—à backend –∑–∞–ø—É—â–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ –Ω–∞ –ø–æ—Ä—Ç—É 8000:

```bash
stripe listen --forward-to localhost:8000/api/credits/webhook
```

–≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞:
- –ü—Ä–æ—Å–ª—É—à–∏–≤–∞–µ—Ç –≤—Å–µ —Å–æ–±—ã—Ç–∏—è Stripe
- –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –∏—Ö –Ω–∞ –≤–∞—à –ª–æ–∫–∞–ª—å–Ω—ã–π endpoint
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç webhook secret (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –µ–≥–æ –≤ .env)

### –®–∞–≥ 3: –¢—Ä–∏–≥–≥–µ—Ä—å—Ç–µ —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ

–í –Ω–æ–≤–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ:

```bash
stripe trigger checkout.session.completed
```

### –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—ã–≤–æ–¥

–í —Ç–µ—Ä–º–∏–Ω–∞–ª–µ —Å–æ `stripe listen` —É–≤–∏–¥–∏—Ç–µ:
```
‚úÖ checkout.session.completed [evt_xxx] -> localhost:8000/api/credits/webhook
```

## –í–∞—Ä–∏–∞–Ω—Ç 3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Ä–µ–∞–ª—å–Ω–æ–π –æ–ø–ª–∞—Ç–æ–π

### –®–∞–≥ 1: –û—Ç–∫—Ä–æ–π—Ç–µ —Å–∞–π—Ç

```
https://aiassistant-4h266kq8h-vendhubs-projects.vercel.app
```

### –®–∞–≥ 2: –í–æ–π–¥–∏—Ç–µ –∏–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å

### –®–∞–≥ 3: –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª Credits

### –®–∞–≥ 4: –í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–∫–µ—Ç

–ù–∞–ø—Ä–∏–º–µ—Ä: **Starter Package** ($10 = 1,000 credits)

### –®–∞–≥ 5: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—É—é –∫–∞—Ä—Ç—É Stripe

```
–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã: 4242 4242 4242 4242
CVC: 123
–î–∞—Ç–∞: 12/25
–ü–æ—á—Ç–æ–≤—ã–π –∫–æ–¥: 12345
```

### –®–∞–≥ 6: –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –æ–ø–ª–∞—Ç—É

### –®–∞–≥ 7: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç

1. ‚úÖ –í–∞—Å –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —É—Å–ø–µ—Ö–∞
2. ‚úÖ –ö—Ä–µ–¥–∏—Ç—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã –Ω–∞ –∞–∫–∫–∞—É–Ω—Ç
3. ‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –≤–∏–¥–Ω–∞ –≤ Stripe Dashboard
4. ‚úÖ Webhook event —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω

## –¢–µ—Å—Ç–æ–≤—ã–µ –∫–∞—Ä—Ç—ã Stripe

### –£—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞
```
4242 4242 4242 4242  - –í–∏–∑–∞ (—É—Å–ø–µ—Ö)
5555 5555 5555 4444  - Mastercard (—É—Å–ø–µ—Ö)
```

### –û—Ç–∫–ª–æ–Ω–µ–Ω–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏  
```
4000 0000 0000 0002  - Card declined
4000 0000 0000 9995  - Insufficient funds
```

### 3D Secure
```
4000 0027 6000 3184  - –¢—Ä–µ–±—É–µ—Ç 3D Secure auth
```

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ Stripe Dashboard

### Payments
https://dashboard.stripe.com/test/payments

–ó–¥–µ—Å—å —É–≤–∏–¥–∏—Ç–µ –≤—Å–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –ø–ª–∞—Ç–µ–∂–∏.

### Webhooks Events  
https://dashboard.stripe.com/test/webhooks/we_1SR4zwBk4MbPWMlrQLAtGDgw

–ó–¥–µ—Å—å —É–≤–∏–¥–∏—Ç–µ –≤—Å–µ webhook —Å–æ–±—ã—Ç–∏—è –∏ –∏—Ö —Å—Ç–∞—Ç—É—Å—ã.

### Customers
https://dashboard.stripe.com/test/customers

–ó–¥–µ—Å—å —É–≤–∏–¥–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π.

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

```bash
sqlite3 data/history.db "SELECT * FROM credit_transactions ORDER BY created_at DESC LIMIT 5;"
```

–ò–ª–∏ —á–µ—Ä–µ–∑ Python:
```python
from agents.database import get_db
db = get_db()
transactions = db.execute_query(
    "SELECT * FROM credit_transactions WHERE type='purchase' ORDER BY created_at DESC LIMIT 5"
)
print(transactions)
```

## Troubleshooting

### Webhook –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 400

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–≤–µ—Ä–Ω—ã–π webhook secret

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü–æ–ª—É—á–∏—Ç–µ secret –∏–∑ Stripe Dashboard
2. –û–±–Ω–æ–≤–∏—Ç–µ `STRIPE_WEBHOOK_SECRET` –≤ Railway
3. –†–µ—Å—Ç–∞—Ä—Ç—É–π—Ç–µ —Å–µ—Ä–≤–∏—Å

### Webhook –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 404

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–≤–µ—Ä–Ω—ã–π URL

**–†–µ—à–µ–Ω–∏–µ:** URL –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å `/api/credits/webhook`, –Ω–µ `/api/webhook`

### –ö—Ä–µ–¥–∏—Ç—ã –Ω–µ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è

**–ü—Ä–∏—á–∏–Ω–∞:** –û—à–∏–±–∫–∞ –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å–æ–±—ã—Ç–∏—è

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Railway
2. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ `user_id` –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ metadata
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ `user_credits` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

### Payment intent –Ω–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–≤–µ—Ä–Ω—ã–µ Stripe –∫–ª—é—á–∏

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `STRIPE_SECRET_KEY` –≤ Railway
2. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ test keys (–Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å `sk_test_`)

## –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ Railway
```bash
railway logs --service a356894b-78b6-4746-8cf4-69103f40b474
```

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ —Å —Ñ–∏–ª—å—Ç—Ä–æ–º
```bash
railway logs | grep -i stripe
railway logs | grep -i webhook
railway logs | grep -i credits
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
```bash
railway variables --service a356894b-78b6-4746-8cf4-69103f40b474 | grep STRIPE
```

### Stripe CLI –∫–æ–º–∞–Ω–¥—ã
```bash
stripe login                    # –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
stripe listen                   # –ü—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ webhooks
stripe trigger [event]          # –¢—Ä–∏–≥–≥–µ—Ä —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ–±—ã—Ç–∏—è
stripe logs                     # –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
stripe webhooks list            # –°–ø–∏—Å–æ–∫ webhooks
```

## Checklist ‚úÖ

- [ ] Stripe CLI —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
- [ ] –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤ Railway
- [ ] Webhook URL –æ–±–Ω–æ–≤–ª–µ–Ω –≤ Stripe Dashboard
- [ ] Webhook –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω –∏–∑ Dashboard (200 OK)
- [ ] –¢–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ
- [ ] –ö—Ä–µ–¥–∏—Ç—ã –¥–æ–±–∞–≤–∏–ª–∏—Å—å –Ω–∞ –∞–∫–∫–∞—É–Ω—Ç
- [ ] –õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —É—Å–ø–µ—à–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É webhook

---

**–î–∞—Ç–∞:** 08.11.2025  
**–í–µ—Ä—Å–∏—è:** 1.0  
**–°—Ç–∞—Ç—É—Å:** –ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é
