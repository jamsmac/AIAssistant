input {
  # HTTP input for application logs
  http {
    port => 5000
    codec => json
  }

  # TCP input for syslog
  tcp {
    port => 5514
    type => syslog
  }

  # File input for local logs
  file {
    path => "/var/log/aiassistant/*.log"
    start_position => "beginning"
    codec => json
  }
}

filter {
  # Parse JSON logs
  if [message] {
    json {
      source => "message"
      target => "parsed"
    }
  }

  # Extract fields
  mutate {
    add_field => {
      "service" => "%{[parsed][service]}"
      "environment" => "%{[parsed][environment]}"
      "level" => "%{[parsed][level]}"
      "correlation_id" => "%{[parsed][correlation_id]}"
    }
  }

  # Parse timestamps
  date {
    match => [ "[parsed][timestamp]", "ISO8601" ]
    target => "@timestamp"
  }

  # Add GeoIP information if IP address present
  if [parsed][ip_address] {
    geoip {
      source => "[parsed][ip_address]"
      target => "geoip"
    }
  }

  # Parse user agent if present
  if [parsed][user_agent] {
    useragent {
      source => "[parsed][user_agent]"
      target => "useragent"
    }
  }

  # Categorize by log level
  if [level] == "ERROR" {
    mutate {
      add_tag => [ "error", "alert" ]
    }
  } else if [level] == "WARNING" {
    mutate {
      add_tag => [ "warning" ]
    }
  }

  # Extract metrics
  if [parsed][metric_name] {
    mutate {
      add_field => {
        "metric_name" => "%{[parsed][metric_name]}"
        "metric_value" => "%{[parsed][value]}"
        "metric_unit" => "%{[parsed][unit]}"
      }
      add_tag => [ "metric" ]
    }
  }

  # Extract audit events
  if [parsed][event] == "audit" {
    mutate {
      add_field => {
        "audit_action" => "%{[parsed][action]}"
        "audit_user_id" => "%{[parsed][user_id]}"
      }
      add_tag => [ "audit" ]
    }
  }
}

output {
  # Send to Elasticsearch
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "aiassistant-%{+YYYY.MM.dd}"
    template_name => "aiassistant"
    template => "/usr/share/logstash/templates/aiassistant.json"
    template_overwrite => true
  }

  # Send errors to separate index
  if "error" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "aiassistant-errors-%{+YYYY.MM.dd}"
    }
  }

  # Send metrics to separate index
  if "metric" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "aiassistant-metrics-%{+YYYY.MM.dd}"
    }
  }

  # Send audit logs to separate index
  if "audit" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "aiassistant-audit-%{+YYYY.MM.dd}"
    }
  }

  # Debug output (comment out in production)
  # stdout {
  #   codec => rubydebug
  # }
}